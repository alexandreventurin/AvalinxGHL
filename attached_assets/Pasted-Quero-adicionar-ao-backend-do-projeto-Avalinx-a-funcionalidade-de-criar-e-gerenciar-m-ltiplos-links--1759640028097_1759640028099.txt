Quero adicionar ao backend do projeto Avalinx a funcionalidade de criar e gerenciar m√∫ltiplos links de avalia√ß√£o para funcion√°rios.
Cada link ser√° baseado no link de avalia√ß√£o principal j√° salvo como Custom Value (AVALINX_GMB_REVIEW_LINK) na conta GHL.

A l√≥gica deve funcionar assim:

Pegar o link principal salvo no GHL.

Criar links derivados ‚Äî um por funcion√°rio.

Armazenar temporariamente em mem√≥ria (simula√ß√£o de banco).

Listar todos os links criados.

Permitir redirecionar e registrar cliques.

No futuro, os links ser√£o hospedados em dom√≠nio externo (me-avalie.link), mas por agora usar uma URL interna do Replit (ex: https://avalinx.repl.co).

üìÅ Nova estrutura de arquivos
src/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ reviewLinks.js
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ reviewLinks.js
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ db.js

üì¶ Arquivo: utils/db.js
// utils/db.js
// Simula√ß√£o de banco de dados em mem√≥ria

export const employeeLinks = new Map(); // id -> dados do link

export function createEmployeeLink({ employeeName, locationId, destination }) {
  const id = Math.random().toString(36).substring(2, 8);
  const newLink = {
    id,
    employeeName,
    locationId,
    destination,
    clicks: 0,
    createdAt: new Date(),
  };
  employeeLinks.set(id, newLink);
  return newLink;
}

export function getAllEmployeeLinks() {
  return Array.from(employeeLinks.values());
}

export function registerClick(id) {
  const link = employeeLinks.get(id);
  if (link) {
    link.clicks++;
  }
  return link;
}

üì¶ Arquivo: services/reviewLinks.js
// services/reviewLinks.js
import { createEmployeeLink, getAllEmployeeLinks, registerClick } from "../utils/db.js";
import { getGoogleReviewLink } from "./reviewLink.js";

const BASE_REDIRECT_DOMAIN = process.env.BASE_REDIRECT_DOMAIN || "https://avalinx.repl.co"; 
// ‚ö†Ô∏è depois ser√° "https://me-avalie.link"

export async function createLinkForEmployee({ accessToken, locationId, employeeName }) {
  // 1Ô∏è‚É£ Busca o link principal salvo no GHL (Custom Value)
  const destination = await getGoogleReviewLink({ accessToken, locationId });
  if (!destination) {
    throw new Error("Google Review link not found for this location.");
  }

  // 2Ô∏è‚É£ Cria o link derivado
  const newLink = createEmployeeLink({
    employeeName,
    locationId,
    destination,
  });

  // 3Ô∏è‚É£ Monta a URL final
  return {
    ...newLink,
    shortUrl: `${BASE_REDIRECT_DOMAIN}/employee-links/go/${newLink.id}`,
  };
}

export function listEmployeeLinks() {
  return getAllEmployeeLinks();
}

export function trackEmployeeClick(id) {
  return registerClick(id);
}

üì¶ Arquivo: routes/reviewLinks.js
// routes/reviewLinks.js
import express from "express";
import { getToken } from "../utils/tokens.js";
import { createLinkForEmployee, listEmployeeLinks, trackEmployeeClick } from "../services/reviewLinks.js";

const router = express.Router();

/**
 * POST /employee-links/create
 * Cria um novo link de avalia√ß√£o para um funcion√°rio.
 */
router.post("/create", async (req, res) => {
  try {
    const { employeeName, locationId } = req.body;
    if (!employeeName || !locationId) {
      return res.status(400).json({ error: "employeeName and locationId required" });
    }

    const tokenData = getToken(locationId);
    if (!tokenData?.access_token) {
      return res.status(401).json({ error: "GHL connection not found" });
    }

    const link = await createLinkForEmployee({
      accessToken: tokenData.access_token,
      locationId,
      employeeName,
    });

    res.json({ message: "Employee link created successfully.", link });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Failed to create link", details: err.message });
  }
});

/**
 * GET /employee-links/list
 * Lista todos os links de funcion√°rios criados.
 */
router.get("/list", (req, res) => {
  res.json(listEmployeeLinks());
});

/**
 * GET /employee-links/go/:id
 * Redireciona para o link de review original e registra clique.
 */
router.get("/go/:id", (req, res) => {
  const { id } = req.params;
  const link = trackEmployeeClick(id);
  if (link) {
    res.redirect(link.destination);
  } else {
    res.status(404).send("Link not found");
  }
});

export default router;

üì¶ Atualize o src/server.js

Adicione o novo m√≥dulo:

import reviewLinksRoutes from "./routes/reviewLinks.js";
app.use("/employee-links", reviewLinksRoutes);

‚öôÔ∏è Vari√°vel de ambiente opcional

Adicione no .env do Replit (ou Railway futuramente):

BASE_REDIRECT_DOMAIN=https://avalinx.repl.co


üëâ Esse dom√≠nio base servir√° para gerar os links curtos.
Mais tarde, basta trocar para https://me-avalie.link.

üß™ Testes pr√°ticos
1Ô∏è‚É£ Criar link de funcion√°rio
POST /employee-links/create
Content-Type: application/json
{
  "employeeName": "Paulo",
  "locationId": "xiXPfRT3hyJMAdmwxc0T"
}


‚úÖ Esperado:

{
  "message": "Employee link created successfully.",
  "link": {
    "id": "x2p9kz",
    "employeeName": "Paulo",
    "shortUrl": "https://avalinx.repl.co/employee-links/go/x2p9kz",
    "destination": "https://search.google.com/local/writereview?placeid=..."
  }
}

2Ô∏è‚É£ Listar todos os links
GET /employee-links/list


‚úÖ Esperado:

[
  {
    "id": "x2p9kz",
    "employeeName": "Paulo",
    "clicks": 0,
    "shortUrl": "https://avalinx.repl.co/employee-links/go/x2p9kz",
    "destination": "..."
  }
]

3Ô∏è‚É£ Testar redirecionamento (clique simulado)
GET /employee-links/go/x2p9kz


‚úÖ Redireciona pro link do Google Review
‚úÖ Incrementa contador de cliques

üí° Funcionamento interno

Cada link de funcion√°rio usa o mesmo link principal (GHL ‚Üí Custom Value).

O redirecionamento √© controlado por voc√™ (no Replit agora, no me-avalie.link depois).

O tracking (cliques, datas, nomes) est√° pronto para ser migrado para banco real.

‚úÖ Resultado esperado (Etapa 2B)

Criar m√∫ltiplos links de avalia√ß√£o (um por funcion√°rio).

Listar e acompanhar os cliques.

Redirecionar automaticamente para o link do Google Review.

Estrutura j√° compat√≠vel com whitelabel e tracking futuro.

Resumo do Prompt:

Crie as pastas e arquivos conforme descrito.
Ap√≥s colar o c√≥digo, rode o projeto no Replit e teste os endpoints /employee-links/create, /employee-links/list e /employee-links/go/:id.
Os links ser√£o criados e redirecionar√£o para o Google Meu Neg√≥cio vinculado ao GHL.