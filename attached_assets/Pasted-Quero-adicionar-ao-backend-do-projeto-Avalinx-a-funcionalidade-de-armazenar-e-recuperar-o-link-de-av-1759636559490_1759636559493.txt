Quero adicionar ao backend do projeto Avalinx a funcionalidade de armazenar e recuperar o link de avalia√ß√£o do Google Meu Neg√≥cio (GMB) de cada conta GHL, usando o recurso de Custom Values do pr√≥prio GoHighLevel.

Use o padr√£o de c√≥digo que j√° est√° sendo usado (Express + Axios + modulariza√ß√£o em /routes, /services, /utils).

üéØ Objetivo

O sistema deve:

Permitir que o usu√°rio cole o link de review manualmente (do tipo https://search.google.com/local/writereview?...).

Salvar esse link dentro da conta GHL como um Custom Value com a chave AVALINX_GMB_REVIEW_LINK.

Permitir ler o link salvo em chamadas futuras.

(Opcional) Criar automaticamente o Custom Value, se ele n√£o existir.

üìÅ Arquitetura esperada
src/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ reviews.js       ‚úÖ novo ou atualizado
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ reviewLink.js    ‚úÖ novo
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ tokens.js        (j√° existe)

üì¶ Arquivo: src/services/reviewLink.js
// src/services/reviewLink.js
import axios from "axios";

const GHL_BASE = "https://services.leadconnectorhq.com";
const VERSION = "2021-07-28"; // mantenha compat√≠vel com suas outras chamadas

function authHeaders(token) {
  return {
    Authorization: `Bearer ${token}`,
    Version: VERSION,
    "Content-Type": "application/json",
  };
}

// 1. Buscar todos os custom values da location
export async function getCustomValues({ accessToken, locationId }) {
  const { data } = await axios.get(
    `${GHL_BASE}/locations/${locationId}/customValues`,
    { headers: authHeaders(accessToken) }
  );
  return data;
}

// 2. Criar novo custom value
export async function createCustomValue({ accessToken, locationId, key, value }) {
  const body = { key, value };
  const { data } = await axios.post(
    `${GHL_BASE}/locations/${locationId}/customValues`,
    body,
    { headers: authHeaders(accessToken) }
  );
  return data;
}

// 3. Atualizar custom value existente
export async function updateCustomValue({ accessToken, locationId, id, key, value }) {
  const body = { key, value };
  const { data } = await axios.put(
    `${GHL_BASE}/locations/${locationId}/customValues/${id}`,
    body,
    { headers: authHeaders(accessToken) }
  );
  return data;
}

// 4. Fun√ß√£o central: salvar ou atualizar o link do Google
export async function saveGoogleReviewLink({ accessToken, locationId, link }) {
  const all = await getCustomValues({ accessToken, locationId });
  const existing = all?.find(cv => cv.key === "AVALINX_GMB_REVIEW_LINK");

  if (existing) {
    const updated = await updateCustomValue({
      accessToken,
      locationId,
      id: existing.id,
      key: "AVALINX_GMB_REVIEW_LINK",
      value: link,
    });
    return { updated: true, data: updated };
  } else {
    const created = await createCustomValue({
      accessToken,
      locationId,
      key: "AVALINX_GMB_REVIEW_LINK",
      value: link,
    });
    return { created: true, data: created };
  }
}

// 5. Fun√ß√£o central: buscar o link salvo
export async function getGoogleReviewLink({ accessToken, locationId }) {
  const all = await getCustomValues({ accessToken, locationId });
  const existing = all?.find(cv => cv.key === "AVALINX_GMB_REVIEW_LINK");
  return existing ? existing.value : null;
}

üì¶ Arquivo: src/routes/reviews.js
// src/routes/reviews.js
import express from "express";
import { getToken } from "../utils/tokens.js";
import {
  saveGoogleReviewLink,
  getGoogleReviewLink,
} from "../services/reviewLink.js";

const router = express.Router();

/**
 * POST /reviews/set-link
 * Recebe um link de avalia√ß√£o (Google Meu Neg√≥cio)
 * e salva como Custom Value no GHL
 */
router.post("/set-link", async (req, res) => {
  try {
    const { locationId, link } = req.body;
    if (!locationId || !link) {
      return res.status(400).json({ error: "locationId and link are required" });
    }

    const tokenData = getToken(locationId);
    if (!tokenData?.access_token) {
      return res.status(401).json({ error: "GHL connection not found" });
    }

    const result = await saveGoogleReviewLink({
      accessToken: tokenData.access_token,
      locationId,
      link,
    });

    res.json({
      message: "Google Review link saved successfully.",
      result,
    });
  } catch (err) {
    console.error("Error saving review link:", err?.response?.data || err);
    res.status(500).json({ error: "Failed to save review link" });
  }
});

/**
 * GET /reviews/get-link?locationId=xxxx
 * Retorna o link de avalia√ß√£o salvo (Custom Value)
 */
router.get("/get-link", async (req, res) => {
  try {
    const { locationId } = req.query;
    if (!locationId) {
      return res.status(400).json({ error: "locationId is required" });
    }

    const tokenData = getToken(locationId);
    if (!tokenData?.access_token) {
      return res.status(401).json({ error: "GHL connection not found" });
    }

    const link = await getGoogleReviewLink({
      accessToken: tokenData.access_token,
      locationId,
    });

    if (!link) {
      return res.json({
        message: "No Google Review link found. Please add one via /reviews/set-link",
        link: null,
      });
    }

    res.json({ link });
  } catch (err) {
    console.error("Error getting review link:", err?.response?.data || err);
    res.status(500).json({ error: "Failed to fetch review link" });
  }
});

export default router;

üì¶ Atualize o src/server.js

Adicione a nova rota:

import reviewsRoutes from "./routes/reviews.js";
app.use("/reviews", reviewsRoutes);

üß™ Testes no Postman / Insomnia / Replit
‚ûï Salvar o link
POST /reviews/set-link
Content-Type: application/json

{
  "locationId": "xiXPfRT3hyJMAdmwxc0T",
  "link": "https://search.google.com/local/writereview?placeid=ChIJJXWz-cSt0lYRga4cJoJ_le4"
}


‚úÖ Retorno esperado:

{
  "message": "Google Review link saved successfully.",
  "result": { "created": true, "data": { ... } }
}

üì§ Buscar o link salvo
GET /reviews/get-link?locationId=xiXPfRT3hyJMAdmwxc0T


‚úÖ Retorno esperado:

{
  "link": "https://search.google.com/local/writereview?placeid=ChIJJXWz-cSt0lYRga4cJoJ_le4"
}

üí° Como isso se encaixa no fluxo do Avalinx

Quando o usu√°rio conectar o GHL, o Avalinx verifica se o Custom Value AVALINX_GMB_REVIEW_LINK existe.

Se n√£o existir, exibe instru√ß√µes:

‚ÄúAcesse o painel do GHL ‚Üí Reputation ‚Üí Settings ‚Üí Review Link, copie o link e cole abaixo.‚Äù

O usu√°rio cola o link ‚Üí chama POST /reviews/set-link.

A partir da√≠, tudo o que o Avalinx fizer (NFC, QR, review gate, placar) usar√° esse link via GET /reviews/get-link.

‚úÖ Resultado esperado (fim da Etapa 2A)

O Avalinx agora armazena e l√™ o link oficial de avalia√ß√µes diretamente dentro do GHL.

Tudo fica sincronizado com a conta do cliente (sem duplicar dados).

Essa base ser√° usada para:

Gerar os links rastre√°veis (me-avalie.link),

Criar o placar de funcion√°rios,

Fazer o review gate no futuro.